{"version":3,"file":"ngx-localstorage.directive.js","sourceRoot":"ng://ngx-localstorage/","sources":["lib/directives/ngx-localstorage.directive.ts"],"names":[],"mappings":"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","sourcesContent":["import { AfterViewInit, Directive, ElementRef, EventEmitter, Input, OnDestroy, Output } from '@angular/core';\r\nimport { fromEvent as observableFromEvent, Subscription } from 'rxjs';\r\nimport { debounceTime, filter } from 'rxjs/operators';\r\n\r\nimport { getProperty, setProperty } from '../utils';\r\nimport { LocalStorageService } from '../services/ngx-localstorage.service';\r\nimport { StorageEventService } from '../services/storage-event.service';\r\n\r\n/**\r\n * Provide a directive to directly interact with stored values.\r\n */\r\n@Directive({\r\n  selector: '[ngxLocalStorage]'\r\n})\r\nexport class LocalStorageDirective implements AfterViewInit, OnDestroy {\r\n\r\n  /**\r\n   * The key to use with localstorage.\r\n   */\r\n  @Input('ngxLocalStorage')\r\n  public lsKey: string;\r\n  /**\r\n   * The keys prefix to use.\r\n   */\r\n  @Input()\r\n  public lsPrefix: string;\r\n  /**\r\n   * The event to hook onto value changes.\r\n   */\r\n  @Input()\r\n  public lsEvent: string;\r\n  /**\r\n   * An optional debounce for storage write access after value changes.\r\n   */\r\n  @Input()\r\n  public lsDebounce = 0;\r\n  /**\r\n   * Flag if the bound elements value should be initialized from storage.\r\n   */\r\n  @Input()\r\n  public lsInitFromStorage = false;\r\n  /**\r\n   * An optional transformer to handle falsy values.\r\n   */\r\n  @Input()\r\n  public lsFalsyTransformer?: () => any;\r\n\r\n  /**\r\n   * Provides a path to access the bound elements value property.\r\n   */\r\n  @Input()\r\n  public set lsValuePath(path: any[] | string) {\r\n    if (path != null) {\r\n      this._valuePath = Array.isArray(path) ? path : path.split(',');\r\n    } else {\r\n      this._valuePath = [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Event which gets fired when a bound value got stored.\r\n   */\r\n  @Output()\r\n  public lsStoredValue = new EventEmitter<any>();\r\n\r\n  private _eventSubscription: Subscription;\r\n  private _valuePath: string[] = [];\r\n\r\n  /**\r\n   * Creates a new instance.\r\n   */\r\n  constructor(private readonly er: ElementRef,\r\n    private readonly lss: LocalStorageService,\r\n    private readonly es: StorageEventService) {\r\n\r\n    this.es.stream.pipe(\r\n      // TODO: filter should be more accurate\r\n      filter((ev: StorageEvent) => ev.key && ev.key.indexOf(this.lsKey) >= 0)\r\n    )\r\n      .subscribe((ev: StorageEvent) => {\r\n        setProperty(this._valuePath.length ? this._valuePath : ['value'], ev.newValue, this.er.nativeElement, this.lsFalsyTransformer);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * AfterViewInit lifecycle hook.\r\n   */\r\n  public ngAfterViewInit(): void {\r\n    this._initKey();\r\n    this._initFromStorage();\r\n    this._hookEvent();\r\n  }\r\n\r\n  /**\r\n   * Initalizes the from either the given value or the elements id or name property.\r\n   */\r\n  private _initKey(): void {\r\n    if (!this.lsKey) {\r\n      if (!this.er.nativeElement.id && !this.er.nativeElement.name) {\r\n        throw new Error('No key or element id or name supplied!');\r\n      }\r\n      this.lsKey = this.er.nativeElement.id || this.er.nativeElement.name;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Hooks onto the elements given event to perform storage write on value changes.\r\n   */\r\n  private _hookEvent(): void {\r\n    if (this.lsEvent) {\r\n      this._eventSubscription = observableFromEvent(this.er.nativeElement, this.lsEvent).pipe(\r\n        debounceTime(this.lsDebounce))\r\n        .subscribe(() => {\r\n          this.lss.asPromisable().set(this.lsKey,\r\n            getProperty(this._valuePath.length ? this._valuePath : ['value'], this.er.nativeElement),\r\n            this.lsPrefix)\r\n            .then(() => {\r\n              this.lss.asPromisable().get(this.lsKey, this.lsPrefix)\r\n                .then((value: any) => {\r\n                  this.lsStoredValue.emit(value);\r\n                })\r\n                .catch((err: Error) => console.error(err));\r\n            })\r\n            .catch((err: Error) => console.error(err));\r\n        });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initializes the elements value from storage.\r\n   */\r\n  private _initFromStorage(): void {\r\n    if (this.lsInitFromStorage) {\r\n      this.lss.asPromisable().get(this.lsKey, this.lsPrefix)\r\n        .then((storedValue: any) => {\r\n          setProperty(this._valuePath.length ? this._valuePath : ['value'], storedValue, this.er.nativeElement, this.lsFalsyTransformer);\r\n        })\r\n        .catch((err: Error) => console.error(err));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe from event observable.\r\n   */\r\n  public ngOnDestroy(): void {\r\n    if (this._eventSubscription && !this._eventSubscription.closed) {\r\n      this._eventSubscription.unsubscribe();\r\n    }\r\n  }\r\n}\r\n"]}